<p>Цель:<br># Установить и настроить несколько виртуальных машин.<br># Настроить Iptables в Centos.<br># Анализ сетевых портов в Centos.<br># Написать скрипт для набора правил iptables.<br># Установить и настроить Ftp сервер.<br># Установить и настроить Nginx сервер.<br># Установить и настроить Proxy сервер.<br># Анализ сетевых портов утилитой Nmap.<br># Перехват трафиков утилитой Tcpdump.<br># Блокировка подозрительных IP-адресов.<br># Установить и настроить tripwire.<br>Skills:<br># Администрирование локальных, виртуальных и облачных серверов.<br># Написаниие скриптов.<br># Анализ сетевых технологий.<br><strong>Task:</strong><br>Выводим список текущих правил iptables и проанализируем какие порты открыты в сервере Centos.<br># Администрирование локальных, виртуальных и облачных серверов.<br><strong>Decision:</strong><br>┌──(tuser㉿kvmkali)-[~]<br>└─$ nmap tipcentos<br>[root@kvmcentos ~]# yum install iptables-services<br>[root@kvmcentos ~]# iptables --version<br>[root@kvmcentos ~]# iptables -L -v<br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target prot opt in out source destination<br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target prot opt in out source destination<br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target prot opt in out source destination<br>[root@kvmcentos ~]# systemctl start iptables<br>[root@kvmcentos ~]# systemctl enable iptables<br>[root@kvmcentos ~]# service iptables status<br>┌──(tuser㉿kvmkali)-[~]<br>└─$ nmap tipcentos<br>...<br>PORT STATE SERVICE<br>22/tcp open ssh<br><strong>Task:</strong><br>В сервере Centos Напишем набор правил iptables, в котором мы разрешаем все исходящие соединения и строго ограничиваем входящие.<br>Доступ будет возможен по портам TCP: 21, 22, 25, 53, 80, 143, 443, по портам UDP: 20, 21, 53, также мы пропускаем пакеты для уже установленных соединений.<br>С удаленной машины просканируем порты на нашем сервере.<br># Написание скриптов.<br><strong>Decision:</strong><br>[root@kvmcentos ~]# vim firewall.sh<br>[root@kvmcentos ~]# cat firewall.sh<br>#!/bin/bash<br>IPT="/sbin/iptables"<br># Очищаем правила и удаляем цепочки.<br>root@aw:/# IPT -F<br>root@aw:/# IPT -X<br># По умолчанию доступ запрещен.<br>root@aw:/# IPT -P INPUT DROP<br>root@aw:/# IPT -P FORWARD DROP<br>root@aw:/# IPT -P OUTPUT DROP<br># Список разрешенных TCP и UDP портов.<br>TCP_PORTS="21,22,25,53,80,143,443"<br>UDP_PORTS="53,21,20"<br># Разрешаем пакеты для интерфейса обратной петли.<br>root@aw:/# IPT -A INPUT -i lo -j ACCEPT<br>root@aw:/# IPT -A OUTPUT -o lo -j ACCEPT<br># Разрешаем пакеты для установленных соединений.<br>root@aw:/# IPT -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br># Разрешаем исходящие соединения.<br>root@aw:/# IPT -A OUTPUT -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT<br># Разрешаем доступ к портам, описанным в переменных TCP_PORTS и UDP_PORTS.<br>root@aw:/# IPT -A INPUT -p tcp -m multiport --dport root@aw:/#TCP_PORTS -j ACCEPT<br>root@aw:/# IPT -A INPUT -p udp -m multiport --dport root@aw:/#UDP_PORTS -j ACCEPT<br># Разрешаем исходящий ping.<br>root@aw:/# IPT -A INPUT -p icmp -m icmp --icmp-type echo-reply -j ACCEPT<br>[root@kvmcentos ~]# chmod +x firewall.sh<br>[root@kvmcentos ~]# ./firewall.sh<br>[root@kvmcentos ~]# iptables -L -v<br>Chain INPUT (policy DROP 1986 packets, 87384 bytes)<br>pkts bytes target prot opt in out source destination<br>0 0 ACCEPT all -- lo any anywhere anywhere<br>79 5604 ACCEPT all -- any any anywhere anywhere state RELATED,ESTABLISHED<br>9 396 ACCEPT tcp -- any any anywhere anywhere multiport dports ftp,ssh,smtp,domain,http,imap,https<br>0 0 ACCEPT udp -- any any anywhere anywhere multiport dports domain,ftp,ftp-data<br>0 0 ACCEPT icmp -- any any anywhere anywhere icmp echo-reply<br>Chain FORWARD (policy DROP 0 packets, 0 bytes)<br>pkts bytes target prot opt in out source destination<br>Chain OUTPUT (policy DROP 0 packets, 0 bytes)<br>pkts bytes target prot opt in out source destination<br>0 0 ACCEPT all -- any lo anywhere anywhere<br>60 7920 ACCEPT all -- any any anywhere anywhere state NEW,RELATED,ESTABLISHED<br>[root@kvmcentos ~]# service iptables save<br>┌──(tuser㉿kvmkali)-[~]<br>└─$ nmap tipcentos<br>...<br>PORT STATE SERVICE<br>21/tcp closed ftp<br>22/tcp open ssh<br>25/tcp closed smtp<br>53/tcp closed domain<br>80/tcp closed http<br>143/tcp closed imap<br>443/tcp closed https<br>...<br><strong>Source:</strong><br># https://blog.sedicomm.com/2016/12/16/iptables-ustanovka-i-nastrojka/?ysclid=ln3wplng53988958006#1<br><strong>Task:</strong><br>Обнаружим активные устройства в сети.<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>┌──(tuser㉿kvmkali)-[~]<br>└─$ apt install nmap<br>┌──(tuser㉿kvmkali)-[~]<br>└─$ nmap -sL tipcentos/24<br>...<br>Nmap scan report for KvmKali (tipkali)<br>...<br>Nmap scan report for kvmcentos (tipcentos)<br>...<br>Nmap scan report for kvmubuntu (tipubuntu)<br>...<br><strong>Task:</strong><br>Просканируем хост и проанализируем порт ftp. В некоторых случаях можно вытащить логин и пароль. Такое происходит, когда используются параметры входа по умолчанию.<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>[root@kvmcentos ~]# nmap -sV tipcentos<br>...<br>PORT STATE SERVICE VERSION<br>21/tcp open ftp vsftpd 3.0.5<br>22/tcp open ssh OpenSSH 8.7 (protocol 2.0)<br>80/tcp open http nginx 1.22.1<br>3128/tcp open http-proxy Squid http proxy 5.5<br>...<br>[root@kvmcentos ~]# nmap -sC tipcentos -p 21<br>...<br>PORT STATE SERVICE<br>21/tcp open ftp<br>...<br>root@aw:/# find /usr/share/nmap/scripts/ -name '*.nse' | grep ftp<br>...<br>/usr/share/nmap/scripts/ftp-brute.nse<br>...<br>root@aw:/# nmap --script-help ftp-brute.nse<br>...<br>Performs brute force password auditing against FTP servers.<br>...<br>[root@kvmcentos ~]# nmap --script ftp-brute.nse tipcentos -p 21<br>...<br>PORT STATE SERVICE<br>21/tcp open ftp<br>| ftp-brute:<br>| Accounts: No valid accounts found<br>| Statistics: Performed 324 guesses in 642 seconds, average tps: 7.5<br>|_ ERROR: The service seems to have failed or is heavily firewalled...<br>...<br><strong>Task:</strong><br>Сканируем диапазон портов.<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>┌──(tuser㉿kvmkali)-[~]<br>└─$ nmap -sT -p 21-80 tipcentos<br>...<br>PORT STATE SERVICE<br>21/tcp open ftp<br>22/tcp open ssh<br>25/tcp closed smtp<br>53/tcp closed domain<br><strong>Task:</strong><br>Просканируем удаленный хост (агрессивный режим).<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>┌──(tuser㉿kvmkali)-[~]<br>└─$ nmap -A -T4 tipcentos<br>...<br>PORT STATE SERVICE VERSION<br>20/tcp closed ftp-data<br>21/tcp open ftp vsftpd 3.0.5<br>22/tcp open ssh OpenSSH 8.7 (protocol 2.0)<br>25/tcp closed smtp<br>53/tcp closed domain<br>143/tcp closed imap<br>443/tcp closed https<br>3128/tcp open http-proxy Squid http proxy 5.5<br>|_http-server-header: squid/5.5<br>|_http-title: ERROR: The requested URL could not be retrieved<br>MAC Address: tmaccentos (QEMU virtual NIC)<br>Aggressive OS guesses: Linux 2.6.32 - 3.13 (94%), Linux 2.6.22 - 2.6.36 (92%), Linux 3.10 (92%), Linux 3.10 - 4.11 (92%), Linux 2.6.39 (92%), Linux 2.6.32 (91%), Linux 3.2 - 4.9 (91%), Linux 2.6.32 - 3.10 (91%), Linux 2.6.18 (90%), Linux 3.16 - 4.6 (90%)<br>No exact OS matches for host (test conditions non-ideal).<br>Network Distance: 1 hop<br>Service Info: OS: Unix<br>TRACEROUTE<br>HOP RTT ADDRESS<br>1 0.83 ms tipcentos<br>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br>Nmap done: 1 IP address (1 host up) scanned in 24.18 seconds<br><strong>Source:</strong><br># https://losst.ru/kak-polzovatsya-nmap-dlya-skanirovaniya-seti<br><strong>Task:</strong><br>Перехватываем DNS-трафик между сервером и каким-нибудь узлом в сети.<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>┌──(tuser㉿kvmkali)-[~]<br>└─$ nmap tipwindows12<br>...<br>PORT STATE SERVICE<br>53/tcp open domain<br>80/tcp open http<br>443/tcp open https<br>...<br>[root@kvmcentos ~]# tcpdump -i enp1s0 -n -nn -ttt 'host tipwindows12 and port 53'<br><strong>Task:</strong><br>Перехватываем весь трафик для MAC-адреса tmaccentos на сетевом интерфейсе enp1s0.<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>[root@kvmcentos ~]# ifconfig<br>enp1s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500<br>...<br>ether tmaccentos txqueuelen 1000 (Ethernet)<br>...<br>[root@kvmcentos ~]# tcpdump -n -i enp1s0 "ether host tmaccentos"<br>...<br>┌──(tuser㉿kvmkali)-[~]<br>└─$ ssh tuser@tipcentos<br>[root@kvmcentos ~]# tcpdump -n -i enp1s0 "ether host tmaccentos"<br>...<br>00:11:12.536934 IP tipcentos.58598 &gt; tipubuntu.22: Flags [.], ack 3730, win 501, options [nop,nop,TS val 3107339434 ecr 2462889902], length 0<br>00:11:12.586762 IP tipubuntu.22 &gt; tipcentos.58598: Flags [P.], seq 3730:3782, ack 2242, win 501, options [nop,nop,TS val 2462889993 ecr 3107339434], length 52<br>00:11:12.586838 IP tipubuntu.22 &gt; tipcentos.58598: Flags [P.], seq 3782:3898, ack 2242, win 501, options [nop,nop,TS val 2462889993 ecr 3107339434], length 116<br>00:11:12.588205 IP tipcentos.58598 &gt; tipubuntu.22: Flags [.], ack 3782, win 501, options [nop,nop,TS val 3107339485 ecr 2462889993], length 0<br>00:11:12.588207 IP tipcentos.58598 &gt; tipubuntu.22: Flags [.], ack 3898, win 501, options [nop,nop,TS val 3107339486 ecr 2462889993], length 0<br><strong>Task:</strong><br>Перехватываем только ICMP-пакеты.<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>[root@kvmcentos ~]# tcpdump -i enp1s0 -n -nn -ttt 'ip proto \icmp'<br>...<br>┌──(tuser㉿kvmkali)-[~]<br>└─$ ping tipcentos<br>...<br>64 bytes from tipcentos: icmp_seq=1 ttl=64 time=0.692 ms<br>64 bytes from tipcentos: icmp_seq=2 ttl=64 time=0.764 ms<br>64 bytes from tipcentos: icmp_seq=3 ttl=64 time=0.868 ms<br>64 bytes from tipcentos: icmp_seq=4 ttl=64 time=1.01 ms<br>64 bytes from tipcentos: icmp_seq=5 ttl=64 time=1.13 ms<br>^C<br>...<br>[root@kvmcentos ~]# tcpdump -i enp1s0 -n -nn -ttt 'ip proto \icmp'<br>...<br>00:00:00.000000 IP tipcentos &gt; tipubuntu: ICMP echo request, id 4, seq 1, length 64<br>00:00:00.000171 IP tipubuntu &gt; tipcentos: ICMP echo reply, id 4, seq 1, length 64<br>00:00:01.001145 IP tipcentos &gt; tipubuntu: ICMP echo request, id 4, seq 2, length 64<br>00:00:00.000077 IP tipubuntu &gt; tipcentos: ICMP echo reply, id 4, seq 2, length 64<br>00:00:01.001365 IP tipcentos &gt; tipubuntu: ICMP echo request, id 4, seq 3, length 64<br>00:00:00.000077 IP tipubuntu &gt; tipcentos: ICMP echo reply, id 4, seq 3, length 64<br>00:00:01.001375 IP tipcentos &gt; tipubuntu: ICMP echo request, id 4, seq 4, length 64<br>00:00:00.000077 IP tipubuntu &gt; tipcentos: ICMP echo reply, id 4, seq 4, length 64<br>00:00:01.001573 IP tipcentos &gt; tipubuntu: ICMP echo request, id 4, seq 5, length 64<br>00:00:00.000125 IP tipubuntu &gt; tipcentos: ICMP echo reply, id 4, seq 5, length 64<br><strong>Task:</strong><br>Перехватываем входящий трафик на порт 80. сохраняем статистику в файл my.log для первых 500 пакетов. Будет создан бинарный файл my.log.<br># Анализ сетевых технологий.<br><strong>Decision:</strong><br>[root@kvmcentos ~]# tcpdump -v -i enp1s0 dst port 80<br>...<br>┌──(tuser㉿kvmkali)-[~]<br>└─$ firefox tipcentos:80<br>[root@kvmcentos ~]# tcpdump -v -i enp1s0 dst port 80<br>...<br>14:07:24.835633 IP (tos 0x0, ttl 64, id 15549, offset 0, flags [DF], proto TCP (6), length 60)<br>kvmcentos.45022 &gt; kvmubuntu.http: Flags [S], cksum 0x76d1 (incorrect -&gt; 0x9a90), seq 1076682845, win 64240, options [mss 1460,sackOK,TS val 3110711737 ecr 0,nop,wscale 7], length 0<br>14:07:24.836511 IP (tos 0x0, ttl 64, id 15550, offset 0, flags [DF], proto TCP (6), length 52)<br>kvmcentos.45022 &gt; kvmubuntu.http: Flags [.], cksum 0x76c9 (incorrect -&gt; 0x51b3), ack 2952605173, win 502, options [nop,nop,TS val 3110711738 ecr 3247231251], length 0<br>14:07:24.836838 IP (tos 0x0, ttl 64, id 15551, offset 0, flags [DF], proto TCP (6), length 412)<br>kvmcentos.45022 &gt; kvmubuntu.http: Flags [P.], cksum 0x7831 (incorrect -&gt; 0xb0a2), seq 0:360, ack 1, win 502, options [nop,nop,TS val 3110711739 ecr 3247231251], length 360: HTTP, length: 360<br>GET / HTTP/1.1<br>Host: tipubuntu<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br>Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3<br>Accept-Encoding: gzip, deflate<br>Connection: keep-alive<br>Upgrade-Insecure-Requests: 1<br>14:07:24.844920 IP (tos 0x0, ttl 64, id 15552, offset 0, flags [DF], proto TCP (6), length 52)<br>kvmcentos.45022 &gt; kvmubuntu.http: Flags [.], cksum 0x76c9 (incorrect -&gt; 0x4285), ack 3522, win 489, options [nop,nop,TS val 3110711747 ecr 3247231260], length 0<br>14:07:29.846014 IP (tos 0x0, ttl 64, id 15553, offset 0, flags [DF], proto TCP (6), length 52)<br>kvmcentos.45022 &gt; kvmubuntu.http: Flags [F.], cksum 0x76c9 (incorrect -&gt; 0x2eef), seq 360, ack 3522, win 501, options [nop,nop,TS val 3110716748 ecr 3247231260], length 0<br>14:07:29.846795 IP (tos 0x0, ttl 64, id 15554, offset 0, flags [DF], proto TCP (6), length 52)<br>kvmcentos.45022 &gt; kvmubuntu.http: Flags [.], cksum 0x76c9 (incorrect -&gt; 0x1b63), ack 3523, win 501, options [nop,nop,TS val 3110716749 ecr 3247236262], length 0<br>[root@kvmcentos ~]# tcpdump -v -n -w my.log dst port 80 -c 500<br>...<br>[root@kvmcentos ~]# ls my.log<br>my.log<br>[root@kvmcentos ~]# tcpdump -nr my.log | awk '{print root@aw:/#3}' | grep -oE '[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,}' | sort | uniq -c | sort -rn<br>reading from file my.log, link-type EN10MB (Ethernet), snapshot length 262144<br>dropped privs to tcpdump<br>6 tipkali<br></p>